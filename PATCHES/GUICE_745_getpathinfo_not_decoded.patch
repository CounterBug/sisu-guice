Description: Properly decode URL paths
Author: Tamas Cservenak <tamas@cservenak.net>
Bug-Google: http://code.google.com/p/google-guice/issues/detail?id=745
Last-Update: 2014-02-14

diff --git a/extensions/servlet/src/com/google/inject/servlet/ServletDefinition.java b/extensions/servlet/src/com/google/inject/servlet/ServletDefinition.java
index 1111fde..cbd8f29 100644
--- a/extensions/servlet/src/com/google/inject/servlet/ServletDefinition.java
+++ b/extensions/servlet/src/com/google/inject/servlet/ServletDefinition.java
@@ -26,6 +26,8 @@
 import com.google.inject.spi.ProviderWithExtensionVisitor;
 
 import java.io.IOException;
+import java.net.URI;
+import java.net.URISyntaxException;
 import java.util.Collections;
 import java.util.Enumeration;
 import java.util.HashMap;
@@ -217,6 +219,14 @@ public String getPathInfo() {
             pathInfo = null;
           }
 
+          if (pathInfo != null) {
+            try {
+              pathInfo = new URI(pathInfo).getPath();
+            } catch (URISyntaxException e) {
+              // ugh, just leave it alone then
+            }
+          }
+
           pathInfoComputed = true;
         }
 
diff --git a/extensions/servlet/test/com/google/inject/servlet/ServletDefinitionPathsTest.java b/extensions/servlet/test/com/google/inject/servlet/ServletDefinitionPathsTest.java
index a5ac841..21eff7e 100644
--- a/extensions/servlet/test/com/google/inject/servlet/ServletDefinitionPathsTest.java
+++ b/extensions/servlet/test/com/google/inject/servlet/ServletDefinitionPathsTest.java
@@ -131,6 +131,10 @@ public final void testPathInfoWithServletStyleMatching() throws IOException, Ser
         "/.../h.thing");
     pathInfoWithServletStyleMatching("/path/my/h.thing", "/path", "*.thing", null, "/my/h.thing");
 
+    // Encoded URLs
+    pathInfoWithServletStyleMatching("/path/index%2B.html", "/path", "/*", "/index+.html", "");
+    pathInfoWithServletStyleMatching("/path/a%20file%20with%20spaces%20in%20name.html", "/path", "/*", "/a file with spaces in name.html", "");
+    pathInfoWithServletStyleMatching("/path/Tam%C3%A1s%20nem%20m%C3%A1s.html", "/path", "/*", "/Tam치s nem m치s.html", "");
   }
 
   private void pathInfoWithServletStyleMatching(final String requestUri, final String contextPath,
@@ -227,6 +231,11 @@ public final void testPathInfoWithRegexMatching() throws IOException, ServletExc
     // path
     pathInfoWithRegexMatching("/path/test.com/com.test.MyServletModule", "", "/path/[^/]+/(.*)",
         "com.test.MyServletModule", "/path/test.com/com.test.MyServletModule");
+
+    // Encoded URLs
+    pathInfoWithRegexMatching("/path/index%2B.html", "/path", "/(.)*", "/index+.html", "");
+    pathInfoWithRegexMatching("/path/a%20file%20with%20spaces%20in%20name.html", "/path", "/(.)*", "/a file with spaces in name.html", "");
+    pathInfoWithRegexMatching("/path/Tam%C3%A1s%20nem%20m%C3%A1s.html", "/path", "/(.)*", "/Tam치s nem m치s.html", "");
   }
 
   public final void pathInfoWithRegexMatching(final String requestUri, final String contextPath,
